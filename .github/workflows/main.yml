name: .NET Core

on:
 push:
  branches: [ main ]

jobs:
 build:

  runs-on: ubuntu-latest

  steps:
  - uses: actions/checkout@v2

  - name: Setup .NET Core
    uses: actions/setup-dotnet@v1
    with:
      dotnet-version: '6.0'

  - name: Install dependencies
    run: dotnet restore

  - name: Build
    run: dotnet build --configuration Release --no-restore

  - name: Test
    run: dotnet test --no-restore --verbosity normal

  - name: Add server's public SSH key to known_hosts
    run: |
      echo "$(ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_IP }})" >> ~/.ssh/known_hosts

  - name: Deploy
    run: |
      ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_IP }} << EOF
      cd /var/www/netwix
      git pull
      pm2 restart ecosystem.config.js
      EOF
